import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as u,b as n,t as d,e as a,n as i,g as p,d as s,f as e,r as c,o as k}from"./app-BgNevrm5.js";const h={},m={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},g={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},v=n("nav",{class:"table-of-contents"},[n("ul")],-1),w=n("hr",null,null,-1),f=e(`<p>You&#39;re probably feeling very tired at this point: this has been a long tutorial and you&#39;ve had to learn a lot. Fortunately, this last chapter is a bonus â€“ you don&#39;t need to read this to have a great CloudKit app, but I do add some neat CloudKit technologies here that make the whole experience better.</p><p>So far, the app lets users record a whistle using <code>AVAudioRecorder</code>, send it off to CloudKit, download whistles others have posted, then write suggestions for what song they think it is. What we&#39;re going to add now is the ability for users to register themselves as experts for particular genres - they can say &quot;I know all about jazz and blues music.&quot; When they do that, we&#39;ll automatically tell them when a new whistle has been posted in one of those categories, and they can jump right into the app to have a go at identifying it.</p><p>We&#39;re going to do this with one of the most important technologies in iOS, called push notifications. These are alerts that are delivered straight to the lock screens of users whenever something interesting happens, and the app usually isn&#39;t running at the time. Push is so important to iOS that it comes built into CloudKit, and it&#39;s done so elegantly that this tutorial will be over in no time. In short: don&#39;t worry, the end is in sight!</p><p>Create a new <code>UITableViewController</code> subclass called <code>MyGenresViewController</code>. Add a CloudKit import to it, then add this property:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">var</span> myGenres<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token operator">!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>We&#39;ll use that to track the list of genres the user considers themselves an expert on.</p>`,6),b=n("code",null,"ViewController.swift",-1),y=n("code",null,"viewDidLoad()",-1),C=e(`<div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line">navigationItem<span class="token punctuation">.</span>leftBarButtonItem <span class="token operator">=</span> <span class="token class-name">UIBarButtonItem</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Genres&quot;</span></span><span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token punctuation">.</span>plain<span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token other-directive property">#selector</span><span class="token punctuation">(</span>selectGenre<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Second, add the following method that allows users to choose genres:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token attribute atrule">@objc</span> <span class="token keyword">func</span> <span class="token function-definition function">selectGenre</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> vc <span class="token operator">=</span> <span class="token class-name">MyGenresViewController</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    navigationController<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">pushViewController</span><span class="token punctuation">(</span>vc<span class="token punctuation">,</span> animated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),S=n("code",null,"MyGenresViewController.swift",-1),x=e(`<p>Letting the user choose which genres interest them is easy: we&#39;re going to use <code>UserDefaults</code> to save an array of their expert genres. If there isn&#39;t one already saved, we&#39;ll create an empty array. We&#39;re also going to use a right bar button item with the title &quot;Save&quot; that handles the CloudKit synchronization. More on that later; for now, here&#39;s the <code>viewDidLoad()</code> method that handles loading saved genres:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> defaults <span class="token operator">=</span> <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard</span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">let</span> savedGenres <span class="token operator">=</span> defaults<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;myGenres&quot;</span></span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span></span>
<span class="line">        myGenres <span class="token operator">=</span> savedGenres</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        myGenres <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    title <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;Notify me aboutâ€¦&quot;</span></span></span>
<span class="line">    navigationItem<span class="token punctuation">.</span>rightBarButtonItem <span class="token operator">=</span> <span class="token class-name">UIBarButtonItem</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Save&quot;</span></span><span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token punctuation">.</span>plain<span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token other-directive property">#selector</span><span class="token punctuation">(</span>saveTapped<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    tableView<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">UITableViewCell</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> forCellReuseIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Cell&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When it comes to how many sections and rows we have, we&#39;re going to specify 1 and the value of <code>SelectGenreViewController.genres.count</code> â€“ that static property contains all the genres used in the app, so re-using it here is perfect:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">numberOfSections</span><span class="token punctuation">(</span><span class="token keyword">in</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> numberOfRowsInSection section<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">SelectGenreViewController</span><span class="token punctuation">.</span>genres<span class="token punctuation">.</span>count</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now for the interesting part: we want users to be able to tap on rows that they like, and have iOS show a checkmark next to them. Once a genre is added to the <code>myGenres</code> array, we can check whether it&#39;s in there using the <code>contains()</code> of that array â€“ if the array contains the genre, we put a check next to it.</p><p>Here&#39;s the <code>cellForRowAt</code> method that does just that:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> cellForRowAt indexPath<span class="token punctuation">:</span> <span class="token class-name">IndexPath</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">UITableViewCell</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> cell <span class="token operator">=</span> tableView<span class="token punctuation">.</span><span class="token function">dequeueReusableCell</span><span class="token punctuation">(</span>withIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Cell&quot;</span></span><span class="token punctuation">,</span> <span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> genre <span class="token operator">=</span> <span class="token class-name">SelectGenreViewController</span><span class="token punctuation">.</span>genres<span class="token punctuation">[</span>indexPath<span class="token punctuation">.</span>row<span class="token punctuation">]</span></span>
<span class="line">    cell<span class="token punctuation">.</span>textLabel<span class="token operator">?</span><span class="token punctuation">.</span>text <span class="token operator">=</span> genre</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> myGenres<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>genre<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        cell<span class="token punctuation">.</span>accessoryType <span class="token operator">=</span> <span class="token punctuation">.</span>checkmark</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        cell<span class="token punctuation">.</span>accessoryType <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">none</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> cell</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The other part of this approach is catching <code>didSelectRowAt</code> so that we check and uncheck rows as they are tapped, adding and removing them from the <code>myGenres</code> array as necessary. Adding things to an array is as simple as calling the <code>append()</code> method on the array, but removing takes a little more hassle: we need to use <code>firstIndex(of:)</code> to find the location of an item in the array, and if that returns a value then we use <code>remove(at:)</code> to remove the item from the array at that index.</p><p>As a finishing touch, we&#39;ll call <code>deselectRow(at:)</code> to deselect the selected row, so it highlights only briefly. That&#39;s all there is to it â€“ here&#39;s the <code>didSelectRowAt</code> method:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> didSelectRowAt indexPath<span class="token punctuation">:</span> <span class="token class-name">IndexPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">let</span> cell <span class="token operator">=</span> tableView<span class="token punctuation">.</span><span class="token function">cellForRow</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> selectedGenre <span class="token operator">=</span> <span class="token class-name">SelectGenreViewController</span><span class="token punctuation">.</span>genres<span class="token punctuation">[</span>indexPath<span class="token punctuation">.</span>row<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> cell<span class="token punctuation">.</span>accessoryType <span class="token operator">==</span> <span class="token punctuation">.</span><span class="token keyword">none</span> <span class="token punctuation">{</span></span>
<span class="line">            cell<span class="token punctuation">.</span>accessoryType <span class="token operator">=</span> <span class="token punctuation">.</span>checkmark</span>
<span class="line">            myGenres<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>selectedGenre<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            cell<span class="token punctuation">.</span>accessoryType <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">none</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">let</span> index <span class="token operator">=</span> myGenres<span class="token punctuation">.</span><span class="token function">firstIndex</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> selectedGenre<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                myGenres<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> index<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    tableView<span class="token punctuation">.</span><span class="token function">deselectRow</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> indexPath<span class="token punctuation">,</span> animated<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And now for the challenging part: when users click Save, we want to write their list of genres to <code>UserDefaults</code>, then send them all to iCloud. Then, when new whistles arrive that match a user&#39;s selected genres, we want to notify them with a push message.</p><p>Thanks to what was I&#39;m sure many months of effort from Apple engineers, registering for push messages is a breeze thanks to a class called <code>CKQuerySubscription</code>. This lets you configure a query to run on the iCloud servers, and as soon as that query matches something it will automatically trigger a push message. In our case, that query will be &quot;when anyone publishes a whistle in a genre we care about.&quot;</p><p>But first: we need to flush out any existing subscriptions so that we don&#39;t get duplicate errors. In the interests of keeping it brief, the easiest way to do this is by calling <code>fetchAllSubscriptions()</code> to fetch all <code>CKQuerySubscriptions</code>, then passing each of them into <code>delete(withSubscriptionID:)</code>. As always, it&#39;s up to you to do useful error handling â€“ I&#39;ve done it enough for you already, so you&#39;re most of the way there.</p><p>Note: the two parameters you get from <code>fetchAllSubscriptions()</code> are an optional array of subscriptions and an error if one occurred. You need to unwrap the optional array, because the user might not have any subscriptions. Here&#39;s an initial version of <code>saveTapped()</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token attribute atrule">@objc</span> <span class="token keyword">func</span> <span class="token function-definition function">saveTapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> defaults <span class="token operator">=</span> <span class="token class-name">UserDefaults</span><span class="token punctuation">.</span>standard</span>
<span class="line">    defaults<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>myGenres<span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;myGenres&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> database <span class="token operator">=</span> <span class="token class-name">CKContainer</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>publicCloudDatabase</span>
<span class="line"></span>
<span class="line">    database<span class="token punctuation">.</span>fetchAllSubscriptions <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">unowned</span> <span class="token keyword">self</span><span class="token punctuation">]</span> subscriptions<span class="token punctuation">,</span> error <span class="token keyword">in</span></span>
<span class="line">        <span class="token keyword">if</span> error <span class="token operator">==</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">let</span> subscriptions <span class="token operator">=</span> subscriptions <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> subscription <span class="token keyword">in</span> subscriptions <span class="token punctuation">{</span></span>
<span class="line">                    database<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>withSubscriptionID<span class="token punctuation">:</span> subscription<span class="token punctuation">.</span>subscriptionID<span class="token punctuation">)</span> <span class="token punctuation">{</span> str<span class="token punctuation">,</span> error <span class="token keyword">in</span></span>
<span class="line">                        <span class="token keyword">if</span> error <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token comment">// do your error handling here!</span></span>
<span class="line">                            <span class="token function">print</span><span class="token punctuation">(</span>error<span class="token operator">!</span><span class="token punctuation">.</span>localizedDescription<span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// more code to come!</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// do your error handling here!</span></span>
<span class="line">            <span class="token function">print</span><span class="token punctuation">(</span>error<span class="token operator">!</span><span class="token punctuation">.</span>localizedDescription<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Again, please do put in some user-facing error messages telling users what&#39;s going on â€“ they won&#39;t see the Xcode log messages, and it&#39;s important to keep them informed.</p><p>There&#39;s just one more thing to do before this entire project is done, and that&#39;s registering subscriptions with iCloud and handling the result. You tell it what condition to match and what message to send, then call the <code>save()</code> method, and you&#39;re done â€“ iCloud takes care of the rest. Normally you&#39;d need to opt into push messages and create a push certificate, but again Xcode and iCloud have taken away all this work when you enabled CloudKit what feels like long ago.</p><p>To make this work, we&#39;re going to loop through each string in the <code>myGenres</code> array, create a predicate that searches for it, then use that to create a <code>CKQuerySubscription</code> using the option <code>.firesOnRecordCreation</code>. That means we want this subscription to be informed when any record is created that matches our genre predicate.</p><p>If you want to attach a visible message to a push notification, you need to create a <code>CKSubscription.NotificationInfo</code> object and set its <code>alertBody</code> property. If you want an invisible push (one that launches your app in the background silently) you should set <code>shouldSendContentAvailable</code> to be true instead.</p><p>We&#39;re going to set a notification message that contains the genre that changed by using Swift&#39;s string interpolation. We&#39;re also going to use the value <code>default</code> for the <code>soundName</code> property, which will trigger the default iOS tri-tone sound when the message arrives. With that done, we can call <code>save()</code> to send it off to iCloud, then handle any error messages that come back.</p><p>That&#39;s it â€“ here&#39;s the code to put in place of the <code>more code to come!</code> comment:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">for</span> genre <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>myGenres <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> predicate <span class="token operator">=</span> <span class="token class-name">NSPredicate</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span><span class="token string-literal"><span class="token string">&quot;genre = %@&quot;</span></span><span class="token punctuation">,</span> genre<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">let</span> subscription <span class="token operator">=</span> <span class="token class-name">CKQuerySubscription</span><span class="token punctuation">(</span>recordType<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Whistles&quot;</span></span><span class="token punctuation">,</span> predicate<span class="token punctuation">:</span> predicate<span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token punctuation">.</span>firesOnRecordCreation<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> notification <span class="token operator">=</span> <span class="token class-name">CKSubscription</span><span class="token punctuation">.</span><span class="token class-name">NotificationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    notification<span class="token punctuation">.</span>alertBody <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;There&#39;s a new whistle in the </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">genre</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> genre.&quot;</span></span></span>
<span class="line">    notification<span class="token punctuation">.</span>soundName <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;default&quot;</span></span></span>
<span class="line"></span>
<span class="line">    subscription<span class="token punctuation">.</span>notificationInfo <span class="token operator">=</span> notification</span>
<span class="line"></span>
<span class="line">    database<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span> result<span class="token punctuation">,</span> error <span class="token keyword">in</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token operator">=</span> error <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">print</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>localizedDescription<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you run the app now you&#39;ll be able to save your genre preferences and send them off to iCloud, but you won&#39;t get any push messages through just yet. That&#39;s because although iCloud is now totally configured to send push messages when interesting things happened, the user hasn&#39;t opted in to receive them. As you might imagine, Apple doesn&#39;t want to send push messages to users who haven&#39;t explicitly opted in to receive them, so we need to ask for push message permission.</p><figure><img src="https://hackingwithswift.com/img/books/hws/33-6@2x.png" alt="When you request permission to show notifications (local or remote) Apple will display a screen like this one" tabindex="0" loading="lazy"><figcaption>When you request permission to show notifications (local or remote) Apple will display a screen like this one</figcaption></figure>`,24),q=n("code",null,"AppDelegate.swift",-1),I=e(`<div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token class-name">UserNotifications</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Now put this code into the <code>didFinishLaunchingWithOptions</code> method, before the <code>return true</code> line:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token class-name">UNUserNotificationCenter</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestAuthorization</span><span class="token punctuation">(</span>options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>alert<span class="token punctuation">,</span> <span class="token punctuation">.</span>sound<span class="token punctuation">,</span> <span class="token punctuation">.</span>badge<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> granted<span class="token punctuation">,</span> error <span class="token keyword">in</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">let</span> error <span class="token operator">=</span> error <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;D&#39;oh: </span><span class="token interpolation-punctuation punctuation">\\(</span><span class="token interpolation">error<span class="token punctuation">.</span>localizedDescription</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        application<span class="token punctuation">.</span><span class="token function">registerForRemoteNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That requests permission to show alerts to the user, with a small error message being printed if something goes wrong. If there was no error, we call <code>registerForRemoteNotifications()</code>, which creates a unique device token that can be used to message this device. That device token is silently handed off to CloudKit, so we donâ€™t need to do anything other than request it.</p><p>For the sake of completeness, itâ€™s worth adding that if a remote notification arrives while the app is already running, it will be silently ignored. If you want to force iOS to show the alert you must do three things:</p><ol><li>Make the <code>AppDelegate</code> class conform to <code>UNUserNotificationCenterDelegate</code>.</li><li>Set your app delegate to be the delegate for the user notification center.</li><li>Implement user notification center delegateâ€™s <code>willPresent</code> method, calling its completion handler with how you want the alert shown.</li></ol><p>To satisfy step 2, add this line of code before <code>return true</code> inside the app delegateâ€™s <code>didFinishLaunchingWithOptions</code> method:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token class-name">UNUserNotificationCenter</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>For step 3, if you want the alert, sound, and badge of the notification to be shown even when the app is already running, youâ€™d add this method to the app delegate:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift" data-title="swift"><pre><code><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">userNotificationCenter</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> center<span class="token punctuation">:</span> <span class="token class-name">UNUserNotificationCenter</span><span class="token punctuation">,</span> willPresent notification<span class="token punctuation">:</span> <span class="token class-name">UNNotification</span><span class="token punctuation">,</span> withCompletionHandler completionHandler<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token class-name">UNNotificationPresentationOptions</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">completionHandler</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>alert<span class="token punctuation">,</span> <span class="token punctuation">.</span>sound<span class="token punctuation">,</span> <span class="token punctuation">.</span>badge<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you want only part of the notification to be used, just change the array being passed to <code>completionHandler()</code>.</p><p>That&#39;s it. No, really â€“ this epic project is now done. Go ahead and run the app on a real iOS device, register for certain genres, then quit the app â€“ unplug your phone, lock it, and put it to one side. Now launch the app in the simulator and create a new whistle in one of the genre you just marked, and you&#39;ll get your push.</p>`,12);function _(l,K){const o=c("VPCard"),t=c("FontIcon");return k(),u("div",null,[n("h1",m,[n("a",g,[n("span",null,d(l.$frontmatter.title)+" ê´€ë ¨",1)])]),a(o,i(p({title:"Hacking with iOS â€“ learn to code iPhone and iPad apps with free Swift tutorials",desc:"Learn Swift coding for iOS with these free tutorials â€“ learn Swift, iOS, and Xcode",link:"/hackingwithswift.com/read/README.md",logo:"https://hackingwithswift.com/favicon.svg",background:"rgba(174,10,10,0.2)"})),null,16),v,w,a(o,i(p({title:"Delivering notifications with CloudKit push messages: CKQuerySubscription | Hacking with iOS",desc:"Delivering notifications with CloudKit push messages: CKQuerySubscription",link:"https://hackingwithswift.com/read/33/8/delivering-notifications-with-cloudkit-push-messages-ckquerysubscription",logo:"https://hackingwithswift.com/favicon.svg",background:"rgba(174,10,10,0.2)"})),null,16),f,n("p",null,[s("Before we starting adding code to this new view controller, we need to make two small changes in "),a(t,{icon:"fa-brands fa-swift"}),b,s(". First, add this in "),y,s(":")]),C,n("p",null,[s("Now, back to "),a(t,{icon:"fa-brands fa-swift"}),S,s(". We can split this code into two parts: all the bits that handle users selecting their experts genres and saving that list, and the CloudKit part that tells iCloud we want to be notified when a new whistle has been published that might be of interest to this user.")]),x,n("p",null,[s("Go to "),a(t,{icon:"fa-brands fa-swift"}),q,s(" and add an import for the UserNotifications framework:")]),I])}const T=r(h,[["render",_],["__file","08-delivering-notifications-with-cloudkit-push-messages-ckquerysubscription.html.vue"]]),D=JSON.parse('{"path":"/hackingwithswift.com/read/33/08-delivering-notifications-with-cloudkit-push-messages-ckquerysubscription.html","title":"Delivering notifications with CloudKit push messages: CKQuerySubscription","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Delivering notifications with CloudKit push messages: CKQuerySubscription","description":"Article(s) > Delivering notifications with CloudKit push messages: CKQuerySubscription","category":["Swift","iOS","Article(s)"],"tag":["blog","hackingwithswift.com","crashcourse","swift","xcode","appstore","ios"],"head":[[{"meta":null},{"property":"og:title","content":"Article(s) > Delivering notifications with CloudKit push messages: CKQuerySubscription"},{"property":"og:description","content":"Delivering notifications with CloudKit push messages: CKQuerySubscription"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/hackingwithswift.com/read/33/08-delivering-notifications-with-cloudkit-push-messages-ckquerysubscription.html"}],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/hackingwithswift.com/read/33/08-delivering-notifications-with-cloudkit-push-messages-ckquerysubscription.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Delivering notifications with CloudKit push messages: CKQuerySubscription"}],["meta",{"property":"og:description","content":"Article(s) > Delivering notifications with CloudKit push messages: CKQuerySubscription"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://hackingwithswift.com/img/books/hws/33-6@2x.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:tag","content":"hackingwithswift.com"}],["meta",{"property":"article:tag","content":"crashcourse"}],["meta",{"property":"article:tag","content":"swift"}],["meta",{"property":"article:tag","content":"xcode"}],["meta",{"property":"article:tag","content":"appstore"}],["meta",{"property":"article:tag","content":"ios"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Delivering notifications with CloudKit push messages: CKQuerySubscription\\",\\"image\\":[\\"https://hackingwithswift.com/img/books/hws/33-6@2x.png\\"],\\"dateModified\\":null,\\"author\\":[]}"]],"isOriginal":false},"headers":[],"git":{"contributors":[{"name":"chanhi2000","email":"chanhi2000@gmail.com","commits":2}]},"readingTime":{"minutes":7.13,"words":2140},"filePathRelative":"hackingwithswift.com/read/33/08-delivering-notifications-with-cloudkit-push-messages-ckquerysubscription.md","excerpt":"\\n"}');export{T as comp,D as data};
