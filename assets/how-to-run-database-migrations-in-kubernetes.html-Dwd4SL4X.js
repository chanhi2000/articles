import{_ as m}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as g,b as n,t as h,e as a,n as c,g as u,w as t,d as s,a as k,f as i,r as p,o as b}from"./app-BgNevrm5.js";const v={},f={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},y={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},_={class:"table-of-contents"},w=n("hr",null,null,-1),q=i('<p>In the era of Microservices and Kubernetes, managing database migrations has become more complex than ever. Traditional methods of running migrations during application startup are no longer sufficient.</p><p>This article explores various approaches to handling database migrations in a Kubernetes environment, with a focus on Go tooling. You&#39;ll get the most out of this article if you already have some experience with Go, Kubernetes, and relational databases.</p><hr><h2 id="the-challenge-of-migrations-in-kubernetes" tabindex="-1"><a class="header-anchor" href="#the-challenge-of-migrations-in-kubernetes"><span>The Challenge of Migrations in Kubernetes</span></a></h2><p>Kubernetes introduces new challenges for database migrations:</p><ul><li>Multiple replicas starting simultaneously. These can span the same migration twice which may introduce some database locks.</li><li>Separation of concerns between application and migration logic. This means itâ€™s good to be able to run or rollback migrations without redeploying your application.</li></ul><hr><h2 id="popular-migration-tools-for-golang" tabindex="-1"><a class="header-anchor" href="#popular-migration-tools-for-golang"><span>Popular Migration Tools for Golang</span></a></h2>',8),x={href:"https://packagemain.tech/i/149097592/database-migrations",target:"_blank",rel:"noopener noreferrer"},A={id:"_1-golang-migrate-nigrate",tabindex:"-1"},M={class:"header-anchor",href:"#_1-golang-migrate-nigrate"},D={href:"https://github.com/golang-migrate/migrate",target:"_blank",rel:"noopener noreferrer"},K=n("code",null,"golang-migrate/nigrate",-1),R=n("ul",null,[n("li",null,"Widely used and supports numerous databases."),n("li",null,"Simple CLI and API."),n("li",null,"Supports various migration sources (local files, S3, Google Storage).")],-1),T={id:"_2-pressly-goose",tabindex:"-1"},E={class:"header-anchor",href:"#_2-pressly-goose"},C={href:"https://github.com/pressly/goose",target:"_blank",rel:"noopener noreferrer"},H=n("code",null,"pressly/goose",-1),I=n("ul",null,[n("li",null,"Supports main SQL databases."),n("li",null,"Allows migrations written in Go for complex scenarios."),n("li",null,"Flexible versioning schemas.")],-1),P={id:"_3-atlas",tabindex:"-1"},j={class:"header-anchor",href:"#_3-atlas"},S={href:"https://atlasgo.io/",target:"_blank",rel:"noopener noreferrer"},G=i(`<ul><li>Powerful database schema management tool.</li><li>Supports declarative and versioned migrations.</li><li>Offers integrity checks and migration linting.</li><li>Provides GitHub Actions and Terraform provider.</li></ul><hr><h2 id="run-migrations-inside-the-application" tabindex="-1"><a class="header-anchor" href="#run-migrations-inside-the-application"><span>Run Migrations Inside the Application</span></a></h2><p>A naÃ¯ve implementation would be to run the code of the migration directly inside your main function before you start your server.</p><div class="hint-container info"><p class="hint-container-title">Example using <code>golang-migrate</code></p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;database/sql&quot;</span></span>
<span class="line">    <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">    <span class="token string">&quot;log&quot;</span></span>
<span class="line">    <span class="token string">&quot;net/http&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token string">&quot;github.com/golang-migrate/migrate/v4&quot;</span></span>
<span class="line">    <span class="token string">&quot;github.com/golang-migrate/migrate/v4/database/postgres&quot;</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token string">&quot;github.com/golang-migrate/migrate/v4/source/file&quot;</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token string">&quot;github.com/lib/pq&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Database connection parameters</span></span>
<span class="line">    url <span class="token operator">:=</span> <span class="token string">&quot;postgres://user:pass@localhost:5432/dbname&quot;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Connect to the database</span></span>
<span class="line">    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;postgres&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;could not connect to database: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Run migrations</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">runMigrations</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;could not run migrations: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Run the application, for example start the server</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;server failed to start: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">runMigrations</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    driver<span class="token punctuation">,</span> err <span class="token operator">:=</span> postgres<span class="token punctuation">.</span><span class="token function">WithInstance</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token operator">&amp;</span>postgres<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;could not create database driver: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> migrate<span class="token punctuation">.</span><span class="token function">NewWithDatabaseInstance</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">&quot;file://migrations&quot;</span><span class="token punctuation">,</span> <span class="token comment">// Path to your migration files</span></span>
<span class="line">        <span class="token string">&quot;postgres&quot;</span><span class="token punctuation">,</span>          <span class="token comment">// Database type</span></span>
<span class="line">        driver<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;could not create migrate instance: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> migrate<span class="token punctuation">.</span>ErrNoChange <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;could not run migrations: %w&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;migrations completed successfully&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>However, these could cause different issues like your migrations being slow and Kubernetes considering that the pod didnâ€™t start successfully and therefore killing it. You could run those migrations in a Go routine, but how do you handle failures then?</p><p>In cases when multiple pods are created at the same time, you would have a potential concurrency problem.</p><p>It also means your migrations need to be inside your Docker image.</p><p>Even with its downsides, this approach might work well for quick and stable database changes and small projects.</p><hr><h2 id="run-migrations-in-initcontainers" tabindex="-1"><a class="header-anchor" href="#run-migrations-in-initcontainers"><span>Run Migrations in initContainers</span></a></h2>`,11),B={href:"https://kubernetes.io/docs/concepts/workloads/pods/init-containers/",target:"_blank",rel:"noopener noreferrer"},U=i(`<p>If the initContainer fails, the blue/green deployment from Kubernetes wonâ€™t go further and your previous pods stay where they are. This prevents having a newer version of the code without the planned migration.</p><div class="hint-container info"><p class="hint-container-title">Example</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">    <span class="token key atrule">initContainers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> migrations</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> migrate/migrate<span class="token punctuation">:</span>latest</span>
<span class="line">        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/migrate&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;-source&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;file:///migrations&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;-database&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;postgres://user:pass@db:5432/dbname&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;up&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This approach might work well for quick and stable database changes for deployments with a single Pod. And it already separates the application and migration layers.</p><hr><h2 id="run-migrations-as-a-kubernetes-job" tabindex="-1"><a class="header-anchor" href="#run-migrations-as-a-kubernetes-job"><span>Run Migrations as a Kubernetes Job</span></a></h2>`,5),V={href:"https://kubernetes.io/docs/concepts/workloads/controllers/job/",target:"_blank",rel:"noopener noreferrer"},N=i(`<div class="hint-container info"><p class="hint-container-title">Example</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>migrate</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> migrate</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>migration<span class="token punctuation">-</span>image<span class="token punctuation">:</span>latest</span>
<span class="line">        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/app/migrate&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can also combine it with initContainers, making sure that the pod starts only when the job is successful.</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">initContainers</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> migrations<span class="token punctuation">-</span>wait</span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/groundnuty/k8s<span class="token punctuation">-</span>wait<span class="token punctuation">-</span>for<span class="token punctuation">:</span>v2.0</span>
<span class="line">    <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;job&quot;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;my-migration-job&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This approach can solve the problems related to multiple replicas mentioned above.</p><hr><h2 id="helm-hooks" tabindex="-1"><a class="header-anchor" href="#helm-hooks"><span>Helm Hooks</span></a></h2>`,4),O={href:"https://helm.sh/docs/topics/charts_hooks/",target:"_blank",rel:"noopener noreferrer"},J=n("code",null,"pre-install-hook.yaml",-1),F=i(`<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Job</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> include &quot;mychart.fullname&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>migrations</span>
<span class="line">  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">&quot;helm.sh/hook&quot;</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>install<span class="token punctuation">,</span>pre<span class="token punctuation">-</span>upgrade</span>
<span class="line">    <span class="token key atrule">&quot;helm.sh/hook-weight&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;-5&quot;</span></span>
<span class="line">    <span class="token key atrule">&quot;helm.sh/hook-delete-policy&quot;</span><span class="token punctuation">:</span> hook<span class="token punctuation">-</span>succeeded</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> migrations</span>
<span class="line">          <span class="token key atrule">image</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>migrations<span class="token punctuation">-</span>image<span class="token punctuation">:</span>tag</span>
<span class="line">          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./run-migrations.sh&quot;</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In this example, the pre-install hook executes after templates are rendered, but before any resources are created in Kubernetes.</p><p>This of course works only when you use Helm, meaning you need to find something else if you decide not to use Helm.</p><hr><h2 id="best-practices-for-kubernetes-migrations" tabindex="-1"><a class="header-anchor" href="#best-practices-for-kubernetes-migrations"><span>Best Practices for Kubernetes Migrations</span></a></h2><h3 id="decouple-migrations-from-application-code" tabindex="-1"><a class="header-anchor" href="#decouple-migrations-from-application-code"><span>Decouple migrations from application code</span></a></h3><ol><li>Create a separate Docker image for migrations. This ensures that migration logic is encapsulated and doesn&#39;t interfere with the application codebase.</li><li>Use tools like Atlas to manage migrations independently. Tools like Atlas provide features for automating migration processes, scheduling, and rollback.</li></ol><h3 id="use-version-control-for-migrations" tabindex="-1"><a class="header-anchor" href="#use-version-control-for-migrations"><span>Use version control for migrations</span></a></h3><ol><li>Store migration files in your Git repository. This ensures a complete history of migration changes, making it easier to track and revert changes.</li><li>Use sequential or timestamp-based versioning. Sequential versioning guarantees the correct order of migrations which is very important for relational databases.</li></ol><h3 id="ensure-idempotent-migrations" tabindex="-1"><a class="header-anchor" href="#ensure-idempotent-migrations"><span>Ensure idempotent migrations</span></a></h3><ol><li>Ensure migrations can be run multiple times without side effects. Idempotent migrations prevent accidental data corruption or inconsistencies if a migration is run multiple times.</li></ol><h3 id="have-a-rollback-strategy" tabindex="-1"><a class="header-anchor" href="#have-a-rollback-strategy"><span>Have a rollback strategy</span></a></h3><ol><li>Implement and test rollback procedures for each migration. Having a rollback strategy ensures that you can revert changes if a migration fails or causes unexpected issues.</li></ol><h3 id="perform-monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#perform-monitoring-and-logging"><span>Perform monitoring and logging</span></a></h3><ol><li>Use tools like Atlas Cloud for visibility into migration history. Atlas Cloud provides detailed logs and history of migrations, making it easy to track changes and troubleshoot issues.</li></ol><hr><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2><p>Managing database migrations in a Kubernetes environment requires careful planning and execution.</p><p>By leveraging tools like golang-migrate, goose, or atlas, and following best practices, you can create robust, scalable, and maintainable migration strategies.</p><p>Remember to decouple migrations from application code, use version control, and implement proper monitoring to ensure smooth database evolution in your Kubernetes-based architecture.</p><h3 id="resources" tabindex="-1"><a class="header-anchor" href="#resources"><span>Resources</span></a></h3><ul><li><a href="https://packagemain.tech/p/database-migrations-in-kubernetes" target="_blank" rel="noopener noreferrer">Discover more articles from packagemain.tech</a></li><li><a href="https://helm.sh/docs/topics/charts_hooks/" target="_blank" rel="noopener noreferrer">Helm Hooks</a></li></ul>`,22);function L(d,Y){const r=p("VPCard"),e=p("router-link"),o=p("FontIcon"),l=p("SiteInfo");return b(),g("div",null,[n("h1",f,[n("a",y,[n("span",null,h(d.$frontmatter.title)+" ê´€ë ¨",1)])]),a(r,c(u({title:"Go > Article(s)",desc:"Article(s)",link:"/programming/go/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),a(r,c(u({title:"Kubernetes > Article(s)",desc:"Article(s)",link:"/devops/k8s/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),n("nav",_,[n("ul",null,[n("li",null,[a(e,{to:"#the-challenge-of-migrations-in-kubernetes"},{default:t(()=>[s("The Challenge of Migrations in Kubernetes")]),_:1})]),n("li",null,[a(e,{to:"#popular-migration-tools-for-golang"},{default:t(()=>[s("Popular Migration Tools for Golang")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#_1-golang-migrate-nigrate"},{default:t(()=>[s("1. "),a(o,{icon:"iconfont icon-github"}),s("golang-migrate/nigrate")]),_:1})]),n("li",null,[a(e,{to:"#_2-pressly-goose"},{default:t(()=>[s("2. "),a(o,{icon:"iconfont icon-github"}),s("pressly/goose")]),_:1})]),n("li",null,[a(e,{to:"#_3-atlas"},{default:t(()=>[s("3. "),a(o,{icon:"fas fa-globe"}),s("atlas")]),_:1})])])]),n("li",null,[a(e,{to:"#run-migrations-inside-the-application"},{default:t(()=>[s("Run Migrations Inside the Application")]),_:1})]),n("li",null,[a(e,{to:"#run-migrations-in-initcontainers"},{default:t(()=>[s("Run Migrations in initContainers")]),_:1})]),n("li",null,[a(e,{to:"#run-migrations-as-a-kubernetes-job"},{default:t(()=>[s("Run Migrations as a Kubernetes Job")]),_:1})]),n("li",null,[a(e,{to:"#helm-hooks"},{default:t(()=>[s("Helm Hooks")]),_:1})]),n("li",null,[a(e,{to:"#best-practices-for-kubernetes-migrations"},{default:t(()=>[s("Best Practices for Kubernetes Migrations")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#decouple-migrations-from-application-code"},{default:t(()=>[s("Decouple migrations from application code")]),_:1})]),n("li",null,[a(e,{to:"#use-version-control-for-migrations"},{default:t(()=>[s("Use version control for migrations")]),_:1})]),n("li",null,[a(e,{to:"#ensure-idempotent-migrations"},{default:t(()=>[s("Ensure idempotent migrations")]),_:1})]),n("li",null,[a(e,{to:"#have-a-rollback-strategy"},{default:t(()=>[s("Have a rollback strategy")]),_:1})]),n("li",null,[a(e,{to:"#perform-monitoring-and-logging"},{default:t(()=>[s("Perform monitoring and logging")]),_:1})])])]),n("li",null,[a(e,{to:"#conclusion"},{default:t(()=>[s("Conclusion")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#resources"},{default:t(()=>[s("Resources")]),_:1})])])])])]),w,a(l,{name:"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples",desc:"In the era of Microservices and Kubernetes, managing database migrations has become more complex than ever. Traditional methods of running migrations during application startup are no longer sufficient. This article explores various approaches to han...",url:"https://freecodecamp.org/news/how-to-run-database-migrations-in-kubernetes",logo:"https://cdn.freecodecamp.org/universal/favicons/favicon.ico",preview:"https://cdn.hashnode.com/res/hashnode/image/upload/v1727685813983/f4672022-9a38-49c9-a252-96f40181fac1.jpeg"}),q,n("p",null,[s("As I mentioned in another "),n("a",x,[a(o,{icon:"fas fa-globe"}),s("post")]),s(", there are a few different tools you can use to manage your migrations. They are quite similar, so I personally donâ€™t have a strong preference between once or another. I just wanted to provide a few options so you know what the popular tools are.")]),n("h3",A,[n("a",M,[n("span",null,[s("1. "),n("a",D,[a(o,{icon:"iconfont icon-github"}),K])])])]),a(l,{name:"golang-migrate/migrate",desc:"Database migrations. CLI and Golang library.",url:"https://github.com/golang-migrate/migrate",logo:"https://avatars.githubusercontent.com/u/35595841?s=88&v=4",preview:"https://opengraph.githubassets.com/1f35d2451b1c5abfa1f8eb4826ff658d5da9cad0be1585ebbf4f6e7be7c95011/golang-migrate/migrate"}),R,n("h3",T,[n("a",E,[n("span",null,[s("2. "),n("a",C,[a(o,{icon:"iconfont icon-github"}),H])])])]),a(l,{name:"pressly/goose",desc:"A database migration tool. Supports SQL migrations and Go functions.",url:"https://github.com/pressly/goose",logo:"https://avatars.githubusercontent.com/u/18835?s=88&v=4",preview:"https://repository-images.githubusercontent.com/52555254/91019174-ec6c-4690-be08-2cfbcb2a030b"}),I,n("h3",P,[n("a",j,[n("span",null,[s("3. "),n("a",S,[a(o,{icon:"fas fa-globe"}),s("atlas")])])])]),a(l,{name:"Atlas | Manage your database schema as code",desc:"manage your database schema as code",url:"https://atlasgo.io/",logo:"https://atlasgo.io/favicon.ico",preview:"https://og.atlasgo.io/image?title=Schema%20Migration%20Tool%20for%20any%20Language"}),G,n("p",null,[s("By using "),n("a",B,[a(o,{icon:"iconfont icon-k8s"}),s("initContainers")]),s(" in your Kubernetes Deployment, it will run the migration before the main application container starts. This is a good first solution for when scaling is not a problem yet.")]),U,n("p",null,[s("You could create a "),n("a",V,[a(o,{icon:"iconfont icon-k8s"}),s("Kubernetes Job")]),s(" that runs your migrations, and trigger that job during the deployment process before rolling out the application.")]),N,n("p",null,[s("If you use Helm, it has "),n("a",O,[a(o,{icon:"iconfont icon-k8s"}),s("hooks")]),s(" that you can use for running migrations during chart installation/upgrade. You just define a pre-install or pre-upgrade hook in your Helm chart.")]),n("blockquote",null,[a(o,{icon:"iconfont icon-yaml"}),J]),F,k(" TODO: SiteInfo ìƒì„± ")])}const z=m(v,[["render",L],["__file","how-to-run-database-migrations-in-kubernetes.html.vue"]]),Q=JSON.parse('{"path":"/freecodecamp.org/how-to-run-database-migrations-in-kubernetes.html","title":"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples","lang":"en-US","frontmatter":{"lang":"en-US","title":"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples","description":"Article(s) > How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples","icon":"fa-brands fa-golang","category":["Go","DevOps","Kubernetes","Article(s)"],"tag":["blog","freecodecamp.org","go","golang","devops","kubernetes","k8s"],"head":[[{"meta":null},{"property":"og:title","content":"Article(s) > How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples"},{"property":"og:description","content":"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/freecodecamp.org/how-to-run-database-migrations-in-kubernetes.html"}],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/freecodecamp.org/how-to-run-database-migrations-in-kubernetes.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples"}],["meta",{"property":"og:description","content":"Article(s) > How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://cdn.hashnode.com/res/hashnode/image/upload/v1727685813983/f4672022-9a38-49c9-a252-96f40181fac1.jpeg"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://cdn.hashnode.com/res/hashnode/image/upload/v1727685813983/f4672022-9a38-49c9-a252-96f40181fac1.jpeg"}],["meta",{"name":"twitter:image:alt","content":"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples"}],["meta",{"property":"article:author","content":"Alex Pliutau"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:tag","content":"freecodecamp.org"}],["meta",{"property":"article:tag","content":"go"}],["meta",{"property":"article:tag","content":"golang"}],["meta",{"property":"article:tag","content":"devops"}],["meta",{"property":"article:tag","content":"kubernetes"}],["meta",{"property":"article:tag","content":"k8s"}],["meta",{"property":"article:published_time","content":"2024-10-03T00:00:00.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"How to Run Database Migrations in Kubernetes â€“ Different Approaches with Examples\\",\\"image\\":[\\"https://cdn.hashnode.com/res/hashnode/image/upload/v1727685813983/f4672022-9a38-49c9-a252-96f40181fac1.jpeg\\"],\\"datePublished\\":\\"2024-10-03T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Alex Pliutau\\"}]}"]],"prev":"/programming/go/articles/README.md","date":"2024-10-03T00:00:00.000Z","isOriginal":false,"author":"Alex Pliutau","cover":"https://cdn.hashnode.com/res/hashnode/image/upload/v1727685813983/f4672022-9a38-49c9-a252-96f40181fac1.jpeg"},"headers":[{"level":2,"title":"The Challenge of Migrations in Kubernetes","slug":"the-challenge-of-migrations-in-kubernetes","link":"#the-challenge-of-migrations-in-kubernetes","children":[]},{"level":2,"title":"Popular Migration Tools for Golang","slug":"popular-migration-tools-for-golang","link":"#popular-migration-tools-for-golang","children":[{"level":3,"title":"1. golang-migrate/nigrate","slug":"_1-golang-migrate-nigrate","link":"#_1-golang-migrate-nigrate","children":[]},{"level":3,"title":"2. pressly/goose","slug":"_2-pressly-goose","link":"#_2-pressly-goose","children":[]},{"level":3,"title":"3. atlas","slug":"_3-atlas","link":"#_3-atlas","children":[]}]},{"level":2,"title":"Run Migrations Inside the Application","slug":"run-migrations-inside-the-application","link":"#run-migrations-inside-the-application","children":[]},{"level":2,"title":"Run Migrations in initContainers","slug":"run-migrations-in-initcontainers","link":"#run-migrations-in-initcontainers","children":[]},{"level":2,"title":"Run Migrations as a Kubernetes Job","slug":"run-migrations-as-a-kubernetes-job","link":"#run-migrations-as-a-kubernetes-job","children":[]},{"level":2,"title":"Helm Hooks","slug":"helm-hooks","link":"#helm-hooks","children":[]},{"level":2,"title":"Best Practices for Kubernetes Migrations","slug":"best-practices-for-kubernetes-migrations","link":"#best-practices-for-kubernetes-migrations","children":[{"level":3,"title":"Decouple migrations from application code","slug":"decouple-migrations-from-application-code","link":"#decouple-migrations-from-application-code","children":[]},{"level":3,"title":"Use version control for migrations","slug":"use-version-control-for-migrations","link":"#use-version-control-for-migrations","children":[]},{"level":3,"title":"Ensure idempotent migrations","slug":"ensure-idempotent-migrations","link":"#ensure-idempotent-migrations","children":[]},{"level":3,"title":"Have a rollback strategy","slug":"have-a-rollback-strategy","link":"#have-a-rollback-strategy","children":[]},{"level":3,"title":"Perform monitoring and logging","slug":"perform-monitoring-and-logging","link":"#perform-monitoring-and-logging","children":[]}]},{"level":2,"title":"Conclusion","slug":"conclusion","link":"#conclusion","children":[{"level":3,"title":"Resources","slug":"resources","link":"#resources","children":[]}]}],"git":{"contributors":[{"name":"chanhi2000","email":"chanhi2000@gmail.com","commits":1}]},"readingTime":{"minutes":5.06,"words":1517},"filePathRelative":"freecodecamp.org/how-to-run-database-migrations-in-kubernetes.md","localizedDate":"October 3, 2024","excerpt":"\\n","copyright":{"author":"Alex Pliutau"}}');export{z as comp,Q as data};
